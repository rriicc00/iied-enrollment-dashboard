<!DOCTYPE html>
<html lang="en">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<head>
  <meta charset="UTF-8" />
  <title>Enrollment Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      padding: 5px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  {% raw %}
  <div id="app">
    <h2>Enrollment Data Viewer</h2>

    <!-- File selector -->
    <label for="fileSelect">Select a file:</label>
    <select v-model="selectedFile" @change="loadFile">
      <option disabled value="">-- Choose a file --</option>
      <option v-for="file in files" :key="file" :value="file">{{ file }}</option>
    </select>

    <!-- Column dropdown -->
    <div v-if="headers.length > 0" style="margin-top: 15px;">
      <label for="columnSelect">Chart column:</label>
      <select v-model="selectedColumn" @change="drawBarChart">
        <option disabled value="">-- Choose a column --</option>
        <option v-for="header in headers" :key="header" :value="header">{{ header }}</option>
      </select>
    </div>

    <!-- Chart -->
    <canvas id="barChart" width="600" height="400" style="margin-top: 30px;"></canvas>

    <!-- Table -->
    <table v-if="data.length > 0">
      <thead>
        <tr>
          <th v-for="header in headers" :key="header">{{ header }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, index) in data" :key="index">
          <td v-for="header in headers" :key="header">{{ row[header] }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Vue + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    new Vue({
      el: "#app",
      data: {
        files: [],
        selectedFile: "",
        headers: [],
        data: [],
        selectedColumn: "",
        chart: null
      },
      methods: {
        async fetchFiles() {
          const res = await fetch("http://127.0.0.1:5000/api/files");
          const json = await res.json();
          this.files = json.files;
        },
        async loadFile() {
          if (!this.selectedFile) return;
          const res = await fetch(`http://127.0.0.1:5000/api/data/${encodeURIComponent(this.selectedFile)}`);
          const json = await res.json();
          this.data = json;
          this.headers = json.length ? Object.keys(json[0]) : [];
          this.selectedColumn = "";
          if (this.chart) this.chart.destroy(); // reset chart
        },
        drawBarChart() {
          if (!this.selectedColumn || this.data.length === 0) return;

          const counts = {};
          this.data.forEach(row => {
            const val = row[this.selectedColumn] ?? "Unknown";
            counts[val] = (counts[val] || 0) + 1;
          });

          const labels = Object.keys(counts);
          const values = Object.values(counts);

          const ctx = document.getElementById("barChart").getContext("2d");
          if (this.chart) this.chart.destroy();

          this.chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [{
                label: `Count by ${this.selectedColumn}`,
                data: values,
                backgroundColor: "rgba(54, 162, 235, 0.6)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { precision: 0 }
                }
              }
            }
          });
        }
      },
      mounted() {
        this.fetchFiles();
      }
    });
  </script>
  {% endraw %}
</body>